## Component functional requirement test case: PBOneDFluidComponent
## Requirement: Model simplified 1D single phase flow
## with user-specified flow geometry (A and Dh).

## Acceptance criteria: The inlet mass flow rate (determined by A)
## must match the hand-calculated value within a tolerance of 1e-12.
## The pressure drop for a given constant friction (determined by Dh)
## must match the hand-calculated value within a tolerance of 1e-3.

A = 3.14e-4
v = {{ velocity }}
rho = 865.51
mu = 2.6216e-4
Dh = {{ Dh }}
# The friction factor is
f = 0.01
# The inlet flow rate is
m_dot = ${fparse rho*v*A}
# The pressure drop is
dP = ${fparse f/Dh*rho*v*v/2}

[GlobalParams]
  global_init_P = 1.0e5
  global_init_V = ${v}
  global_init_T = 628.15
[]

[EOS]
  [eos]  # Simple linearized Sodium approximation
  	type = PTConstantEOS
    p_0 = 1e5         # Pa
    rho_0 = ${rho}    # kg/m^3
    beta = 2.7524e-4  # K^{-1}
    cp =  1272.0      # at Tavg;
    h_0 = 7.9898e5    # J/kg
    T_0 = 628.15      # K
    mu = ${mu}        # Pa-s
    k =  72           # W/m-K
  []
[]


[Components]
  [pipe1]
    type = PBOneDFluidComponent
    eos = eos
    position = '0 0 0'
    orientation = '0 1 0'

    A = ${A}              # Check cross-sectional flow area is used
    Dh = ${Dh}            # Check hydraulic diameter is used
    length = 1.0
    n_elems = 10

    f = ${f}
  []

  [inlet]
    type = PBTDJ
    input = 'pipe1(in)'
    eos = eos
    v_bc = ${v}
    T_bc = 628.15
  []

  [outlet]
    type = PBTDV
    input = 'pipe1(out)'
    eos = eos
    p_bc = '1.0e5'
  []
[]

[Preconditioning]
  [SMP_PJFNK]
    type = SMP
    full = true
    solve_type = 'PJFNK'
    petsc_options_iname = '-pc_type'
    petsc_options_value = 'lu'
  []
[]

[Postprocessors]
  [m_dot_inlet]
    type = ComponentBoundaryFlow
    input = pipe1(in)
    outputs = none
  []
  [P_outlet]
    type = ComponentBoundaryVariableValue
    input = pipe1(out)
    variable = pressure
    outputs = none
  []
  [P_inlet]
    type = ComponentBoundaryVariableValue
    input = pipe1(in)
    variable = pressure
    outputs = none
  []
  [DeltaP]
    type = DifferencePostprocessor
    value1 = P_inlet
    value2 = P_outlet
    outputs = none
  []
  [check_requirement_A]
    type = PostprocessorComparison
    comparison_type = equals
    value_a = ${m_dot}
    value_b = 'm_dot_inlet'
  []
  [check_requirement_Dh]
    type = PostprocessorComparison
    comparison_type = equals
    value_a = ${dP}
    value_b = 'DeltaP'
    absolute_tolerance = 1e-3
  []
[]

[Executioner]
  type = Steady

  petsc_options_iname = '-ksp_gmres_restart'
  petsc_options_value = '100'

  nl_rel_tol = 1e-8
  nl_abs_tol = 1e-7
  nl_max_its = 20
  l_tol = 1e-4
  l_max_its = 100

  [Quadrature]
    type = TRAP
    order = FIRST
  []
[]

[Outputs]
  print_linear_residuals = false
  [csv]
    type = CSV
  []
  [console]
    type = Console
  []
[]
